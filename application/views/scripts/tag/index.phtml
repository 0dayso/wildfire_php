<link rel="stylesheet" type="text/css" media="screen" href="<?php echo $this->baseUrl();?>/css/sns.css" />

<div class="span11">
  <div style="padding-left:15px" class="nav" id="folders">

  </div>
</div>

<div class="filters">
  <div><a><span class="badge badge-inverse  filter " onclick="filter('');return false;">全部</span></a></div>
  <div><a><span class="badge filter" onclick="filter('.read');return false;">已读</span></a></div>
  <div><a><span class="badge badge-success filter" onclick="filter('.BBS');return false;">论坛</span></a></div>
  <div><a><span class="badge badge-info filter" onclick="filter('.Blog');return false;">博客</span></a></div>
  <div><a><span class="badge badge-warning filter" onclick="filter('.Weibo');return false;">微博</span></a></div>
  <div><a><span class="badge badge-important filter" onclick="filter('.SNS');return false;">社交网站</span></a></div>
  <div><a><span style="background-color:#C99DB7;" class="badge filter" onclick="filter('.ECOM');return false;">电子商务</span></a></div>
</div>

<div class="modal hide">
	<div class="modal-header">
		<button type="button" class="close" data-dismiss="modal">×</button>
		<h3>插入图片链接</h3>
	</div>
	<div class="modal-body" style="margin: 0 0 10px 50px">
		<p>请在跳转到的网站登陆，并进行回复。</p>
		<p><strong id="image_uri" uri="<?php echo $this->image_uri?>">记得在回复时【插入】您的专属图片链接。否则您的回复无法通过审核。</strong></p>
		<textarea class="input-xlarge" id="text" rows="1" style="width:300px;"></textarea>
		<button class="btn btn-large disable" id="copy" style="padding: 4px 14px">复制</button>
		<p>完成后，记得回来确认“已完成回复”哦。</p>
		<p>审核通过后24小时内将获得20积分，每周最多可获得200积分。</p>
		<button data="" class="btn btn-large btn-primary disabled" id="reply" style="margin-top:30px;">懂了，去回复</button>
	</div>
</div>


<script type="text/template" id="container_template">
<div id="infscr-loading" style="display: none;"><img src="<?php echo $this->baseUrl();?>/images/loading-topics.gif" alt="Loading..."><div><em>Loading for more...</em></div></div>
</script>


<script type="text/template" id="tag_template">
	<li><a href="javascript:void(0);" rel="<%= topic_num%>"><%= name%></a></li>
</script>

<script type="text/template" id="topic_template">
<% if(read){ %>
	<div class="topic span3 isotope-item alert <%= site.type %> read" data="<%= id %>">
<%}else{ %>
<div class="topic span3 isotope-item alert <%= site.type %>" data="<%= id %>">
<%} %>
        <div class="box_head title" style="">
              <a href="javascript:void(0)">
              		<% if (_.isEmpty(title)) {%> <%= body.substring(0,30) %> <%} else { %><%= title.substring(0,30) %> <%} %>
              </a>
        </div>
		<div style="width:100%;" class="topic_head">
			<div style="" class="title_td">
				<div class="row-fluid">
					<div class="span11">
						<i class="babytree" style=""></i>
              				<div class="author">
                				<img style="width:50px;height:50px;" src="<%= author.profile_img %> "/><br> <%= author.name %>
              				</div>
            				来自: <%= site.name %><br>
          					<button class="btn reply_window">  我要回复	</button>    
            			<br />           
        
					</div>
			        <div span="span2">
			        	<i class="icon-zh-CN" style="float:right"></i>
			        </div>
				</div>
				<div style="display: none;" class="topicPRR">
			    	<div class="posts"><div>Loading...</div></div>
                    <!--
			        <div class="responses">
			        </div>
			        <div class="reply" id="reply_box_1">
						<form action="">
						    <textarea placeholder="在这里填写您想回复的话" style="width:90%" rows="4" class="reply-content"></textarea>
						    <button id="" class="btn btn-primary add-url">添加原帖链接</button>
						<img id="submit_button_1" class="weibo-reply-img" style="cursor:pointer;padding-bottom: 10px;" src="<?php echo $this->baseUrl();?>/images/weiboreply.gif"></img>
						</form>
					</div>
                    -->
				</div>
			</div>
		</div>
		
		
	</div>
</script>
<script type="text/template" id="posts_template">

<% var length = models.length;var hiddenFormat=false;var index = 0;if(length>5){hiddenFormat=true}; %>
<%  _.each(models, function(post){ %>
<% if(hiddenFormat && index>1 && index< length-1){ %>
<div class="post row-fluid" style="display:none">
<%}else{ %>
<div class="post row-fluid">
<%} %>

<% if (index!=0) { %>
	<div class="head span2">
		<div style="vertical-align: top; margin-left: 0px; overflow-x:hidden;">
        		<img style="width:35px; height:35px;" src='<%= post.get("profile_img_path") %>' /><br>
		</div>
	</div>
<% } %>

<% if (index==0) { %>
	<div class="span11">
<% }else{ %>
	<div class="span9">
	<div class=""><%= post.get("username")%></div>

<% } %>
		<div class="body">
			<table>
				<tbody>
					<tr>
                        <% if (post.get("body").length<50) {%>
						<td><%= post.get("body") %></td>
                        <%}else{ %>
						<td><%= post.get("body").substring(0,50) %>...</td>
                        <%} %>                      
					</tr>
				</tbody>
			</table>
		</div>
		<div class="body_translated"></div>
		<div class="date"><%=post.get("date")%></div>
	</div>
</div>
<% if(hiddenFormat && index == 2){ %>
<div class="post posthidden"></div>
<div class="post posthidden showHiddenPost" style="cursor:pointer;text-align:center;"><span><%= length-2 %> More</span></div>
<div class="post posthidden"></div>
<% } %>
<% index ++;%>
<% }); %>
</script>
<script src="<?php echo $this->baseUrl();?>/js/backbone/tags/post.js"></script>
<script src="<?php echo $this->baseUrl();?>/js/backbone/tags/topic.js"></script>
<script src="<?php echo $this->baseUrl();?>/js/backbone/tags/tag.js"></script>
<script src="<?php echo $this->baseUrl();?>/js/sns_utility.js"></script>
<script type="text/javascript">

function filter(category){
	jQuery(".topics").isotope({filter:category});
}

function getTopics(key,count,page){

}
function openIssues(e){
	var description = jQuery("<div class='issuedetail'>"+jQuery(e).attr("description")+"</div>");
	var topic = jQuery(e).attr("data");
	var issue = jQuery(e).attr("issue");
	var button = jQuery("<button class='btn btn-primary'>领取</button>").bind("click",function(){getIssue(topic,issue)});
	jQuery(".topics").html(description).append(button);
	
}
function getIssue(topic,issue){
	jQuery(".topics").html("读取中...");
	jQuery.post("tag/ajaxgetissue",{issue:issue},function(){
		jQuery.get("tag/ajaxissuedetail?key="+topic,function(data){
			jQuery(".topics").html(data);
		});
	});
}

// works in ie and firefox, but not in chrome
$("#copy").bind("click", function(){
	txt = $(this).prev().val();
	if (window.clipboard) {
    window.clipboard.clearData();
    window.clipboard.setData("Text", txt);
  } else if (navigator.userAgent.indexOf("Opera") != -1) {
     // do nothing    
  } else if (window.netscape) {
      try {
          netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
      } catch (e) {
          alert("被浏览器拒绝！\n请在浏览器地址栏输入'about:config'并回车\n然后将 'signed.applets.codebase_principal_support'设置为'true'");
      }
      var clip = Components.classes['@mozilla.org/widget/clipboard;1'].createInstance(Components.interfaces.nsIClipboard);
      if (!clip)   return;
      var trans = Components.classes['@mozilla.org/widget/transferable;1'].createInstance(Components.interfaces.nsITransferable);
      if (!trans) return;
      trans.addDataFlavor('text/unicode');
      var str = new Object();
      var len = new Object();
      var str = Components.classes["@mozilla.org/supports-string;1"].createInstance(Components.interfaces.nsISupportsString);
      var copytext = txt;
      str.data = copytext;
      trans.setTransferData("text/unicode", str, copytext.length * 2);
      var clipid = Components.interfaces.nsIClipboard;
      if (!clip)   return false;
      clip.setData(trans, null, clipid.kGlobalClipboard);
  } else{
  	alert("您的浏览器不支持，请手动复制");
  }
})


// $("#reply").bind('click', function(){
	// var uri = $(this).attr("data");
	// window.setTimeout(
		// function() {
			// window.open('http://'+uri, '_blank');
			// $("#reply").text("已完成回复");
		// }, 
		// 4000
	// );
	// $('#reply').unbind('click');
// });



// backbone app
      window.AppView = Backbone.View.extend({

        el: jQuery("#inbox"),

        events: {

        },

        initialize: function() {

        	<?php foreach($this->topicsUntaggedSumByFolder as $topicsUntaggedByFolder):?>
//        	var tag = new Tag({
//                name:'<?php echo $topicsUntaggedByFolder['key']?>',
//                topic_num :'<?php echo $topicsUntaggedByFolder['value']?>'
//              });
//        	tags.add(tag);
//        	var view = new TagView({model: tag});
//        	jQuery("#folders").append(view.render().el);        	
       		<?php endforeach;?>


        	var tag = new Tag({
                name:'skin_care',
                topic_num :'0'
              });
        	var view = new TagView({model: tag});
        	
        	this.container = new ContainerView({});
       		jQuery(".filters").after(this.container.render().el);
       		this.container.layout();
       		        	
        	$('a',$(view.render().el)).click();


       		
        },

        render: function() {
        }

      });

      window.App = new AppView;


</script>
